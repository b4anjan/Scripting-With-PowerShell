<#=======================================================================================
Notes:
The script gets the update history and checks if update KB5044273 is already installed.
If the update is already installed, it skips the installation.
If the update is not installed, it prompts for installation.
If the user chooses to install, it installs the update package and checks if update KB504
========================================================================================#>


# Define the list of computers
$computers = Get-Content "$Home\Desktop\KBInstaller.txt"

# Define the update package path
$updatePackagePath = "C:\KB\windows10.0-kb5044273-x64.msu"

# Define the update to check
$updateKB = "5044273"

# Define the expected version
$expectedVersion = "10.0.19041.4894"

# Loop through computers
foreach ($computer in $computers) {
    Write-Host "Running on $computer"

    # Check if computer is online
    if (Test-Connection -ComputerName $computer -Quiet) {
        # Get update history
        $updateHistory = Invoke-Command -ComputerName $computer -ScriptBlock {
            $Session = New-Object -ComObject "Microsoft.Update.Session"
            $Searcher = $Session.CreateUpdateSearcher()
            $Searcher.QueryHistory(0, $Searcher.GetTotalHistoryCount()) |
            Select-Object @{name="KB"; expression={(Select-String -InputObject $_.title -Pattern "(\(\w+\))").matches[0].Value.Replace("(", "").Replace(")", "")}}, @{name="Status"; expression={switch($_.resultcode){
                1 {"In Progress"}
                2 {"Succeeded"}
                3 {"Succeeded With Errors"}
                4 {"Failed"}; 5 {"Aborted"} }}}, Date
        }

        # Check if update KB5044273 is already installed
        $updateInstalled = $updateHistory | Where-Object { $_.KB -eq $updateKB }

        if ($updateInstalled) {
            Write-Host "Update $updateKB is already installed. Skipping..."
        } else {
            Write-Host "Update $updateKB is not installed."

            # Prompt for installation
            $installPrompt = Read-Host "Do you want to install update $updateKB on $computer? (yes/no)"

            if ($installPrompt -eq "yes") {
                Write-Host "Installing update $updateKB on $computer..."

                # Copy update package to remote host
                Copy-Item -Path $updatePackagePath -Destination "\\$computer\C$\Updates" -Force

                # Install update package
                Invoke-Command -ComputerName $computer -ScriptBlock {
                    Start-Process -FilePath "wusa.exe" -ArgumentList "/update /quiet /norestart /forcerestart C:\Updates\windows10.0-kb5044273-x64.msu" -Wait
                }

                # Check if update KB5043064 is installed
                $updateKB3064 = "5043064"
                $updateInstalled3064 = $updateHistory | Where-Object { $_.KB -eq $updateKB3064 }

                if ($updateInstalled3064) {
                    Write-Host "Update $updateKB3064 is installed."
                } else {
                    Write-Host "Update $updateKB3064 is not installed."

                    # Check the version of ntoskrnl.exe
                    $ntoskrnlVersion = Invoke-Command -ComputerName $computer -ScriptBlock {
                        (Get-Item -Path "C:\windows\system32\ntoskrnl.exe").VersionInfo.FileVersion
                    }

                    if ($ntoskrnlVersion -ne $expectedVersion) {
                        Write-Host "C:\windows\system32\ntoskrnl.exe has not been patched."
                        Write-Host "Remote version : $ntoskrnlVersion"
                        Write-Host "Should be : $expectedVersion"
                    }
                }

                # Schedule restart
                $time = (New-TimeSpan -Hours 0 -Minutes 0).TotalSeconds
                Shutdown /m \\$computer /r /t $time
            } elseif ($installPrompt -eq "no") {
                Write-Host "Skipping installation of update $updateKB on $computer."
            } else {
                Write-Host "Invalid input. Skipping installation of update $updateKB on $computer."
            }
        }
    } else {
        Write-Host "Computer is offline!"
    }
}